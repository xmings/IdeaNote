{% extends 'base.html' %}

{% block cssdefine %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/railscasts.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.contextmenu.min.css') }}">
    <style>
        #catalog-tree {
            font-size: 12px;
            margin-left: 0;
        }

        #catalog-tree > #root {
            padding-left: 0;
        }

        .contextmenu-item-custom {
            font-size: 12px;
            font-family: inherit;

        }

        .context-menu-active {
            background-color: #FFE6B0;
        }

        #markdown-editor {
            width: 100%;
            margin-right: 10px;
            font-size: 14px;
            line-grid: create;
            resize: none;
            border: none;
            outline: none;
            line-height: 24px;
            tab-size: 4;
            letter-spacing: 0.05em;
            white-space: pre-wrap;
            word-break:break-word;
            word-wrap:break-word;
            -webkit-font-smoothing:antialiased;
            color: #ceccccfc;
            padding: .5rem .75rem;
            background-color: #2F3030;
            -webkit-transition: all 0.2s ease-out;
             -moz-transition: all 0.2s ease-out;
               -o-transition: all 0.2s ease-out;
                  transition: all 0.2s ease-out;
        }

        #markdown-editor:hover {
            border-color: white;
            box-shadow: none;
            outline: 0;
        }

        #markdown-editor:visited,
        #markdown-editor:active,
        #markdown-editor:focus {
            border-color: white;
            box-shadow: none;
            outline: 0;
        }
        .splitter_panel .vsplitter {
            width: 2px;
            background-color: rgba(128, 128, 128, 0.18);
        }


    </style>
{% endblock %}

{% block jsdefinebefore %}
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/highlight.pack.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.contextmenu.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.ui.position.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/hotkeys.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.inline-attachment.js') }}"></script>

    <script>
        hljs.tabReplace = ' ';
        hljs.initHighlightingOnLoad();
    </script>
{% endblock %}


{% block centerframe %}
    <textarea id="markdown-editor"
                  placeholder="写你想写"
                  onkeydown="editorTab(this)"></textarea>
{% endblock %}


{% block jsdefineafter %}
    <script type="text/javascript">
        $(document).ready(function () {
            editorTab = function(obj){
                if (event.keyCode === 9) {
                    var selectionStart = obj.selectionStart;
                    obj.value = obj.value.substring(0, selectionStart) + "    " + obj.value.substring(obj.selectionEnd);
                    obj.selectionEnd = selectionStart + 4;
                    event.preventDefault();
                }
            };

            preview = function(content) {
                $(".preview").html(marked(content,
                        {
                            highlight: function (code) {
                                return hljs.highlightAuto(code).value;
                            },
                            pedantic: false,
                            gfm: true,
                            tables: true,
                            breaks: true,
                            sanitize: false,
                            smartLists: true,
                            smartypants: false,
                            xhtml: false,
                            headerIds: true,
                            langPrefix: 'hljs ',
                            baseUrl: 'http://localhost:5555/'
                        }
                    )
                );
            };

            editor = $("#markdown-editor");
            editor.keyup(function () {
                content = this.value;
                if (content !== undefined) {
                    preview(content);

                    currentNode = zTreeObj.getSelectedNodes();
                    if (currentNode.length > 0) {
                        node = zTreeObj.getSelectedNodes()[0];
                        $.ajax({
                            url: "{{ url_for('core.updateNode', type='content') }}",
                            type: "post",
                            data: {
                                nodeId: node.id,
                                content: content,
                            },
                            error: function () {
                                toggleFlash("保存失败", true);
                            },
                            dataType: 'json'
                        })
                    }


                }

            });

            editor[0].addEventListener('scroll',function(){
              $(".preview")[0].scrollTop = this.scrollTop;
            });

            save = function() {
                $.post(


                )
            };

            hotkeys('ctrl+s,ctrl+e', function (event, handler) {
                console.log(event, handler);
                switch (handler.key) {
                    case "ctrl+s":
                        save();
                        break;
                    case "ctrl+e":
                        alert('you pressed ctrl+b!');
                        break;
                }
            });

        });
    </script>
{% endblock %}
{% block leftframe %}
    {% include 'catalog.html' %}
{% endblock %}