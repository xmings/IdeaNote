{% extends 'base.html' %}

{% block cssdefine %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/railscasts.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.contextmenu.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/zTreeStyle.css') }}">
{% endblock %}

{% block jsdefinebefore %}
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/highlight.pack.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.contextmenu.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.inline-attachment.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.ztree.core.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.ztree.exedit.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/idea-note.js') }}"></script>

    <script>
        hljs.tabReplace = ' ';
        hljs.initHighlightingOnLoad();
    </script>
{% endblock %}



{% block centerframe %}
    <textarea id="markdown-editor" placeholder="写你想写" spellcheck="false"></textarea>
{% endblock %}


{% block jsdefineafter %}
    <script type="text/javascript">
        $(document).ready(function () {
            catalogTree = $("#catalog-tree");
            editor = $("#markdown-editor");
            previewer = $(".preview");
            preview = function(content) {
                previewer.html(
                    marked(content, {
                        highlight: function (code) {
                            return hljs.highlightAuto(code).value;
                        },
                        pedantic: false,
                        gfm: true,
                        tables: true,
                        breaks: true,
                        sanitize: false,
                        smartLists: true,
                        smartypants: false,
                        xhtml: false,
                        headerIds: true,
                        langPrefix: 'hljs ',
                        //baseUrl: 'http://localhost:5555/'
                    })
                );
            };

            catalogTree.catalog({
                treeDataUrl: "{{ url_for('core.getNodes') }}",
                renameUrl: "{{ url_for('core.updateNode', type='rename') }}",
                flashFunc: flashMessage,
                nodeContent: "{{ url_for('core.getContent') }}",
                previewFunc: preview,
                editor: editor
            });

            syncUrl = "{{ url_for('core.sync', method='sync') }}";

            $.bindTreePopu({
                nodeSeletor: "a[class^='level']",
                syncUrl: syncUrl,
                dropUrl: "{{ url_for('core.dropNode') }}",
                addChildUrl: "{{ url_for('core.addNode') }}",
                flashFunc: flashMessage
            });


            editor.enhance({
                postUrl: "{{ url_for('core.updateNode', type='content') }}",
                previewFunc: preview,
                flashFunc: flashMessage
            });

            editor[0].addEventListener('scroll',function(){
              previewer[0].scrollTop = this.scrollTop;
            });

            editor.inlineattachment({
                uploadUrl: "{{ url_for('core.uploadImage') }}",
                urlText: "![image]({filename})",
                dynamicParams: {
                    nodeId: "zTreeObj.getSelectedNodes()[0].id"
                }
            });


            document.addEventListener('keydown',function(){
                if (event.keyCode === 27){
                    // esc 返回只读模式
                    splitter2.position("0%");
                    event.preventDefault();
                } else if (event.ctrlKey && event.keyCode === 83) {
                    // ctrl+s pull&&push
                    $.syncNote();
                    event.preventDefault();
                } else if (event.ctrlKey && event.keyCode === 73){
                    // ctrl+i 进入编辑模式
                    splitter2.position("50%");
                    event.preventDefault();
                } else if (event.shiftKey && event.keyCode === 83) {
                    // shift+s 切换侧边栏(目录树)
                    if (splitter1.position()>15){
                        splitter1.position("0%")
                    } else {
                        splitter1.position("15%");
                    }
                    event.preventDefault();
                } else if (event.ctrlKey && event.shiftKey && event.keyCode === 70){
                    // ctrl+shift+f //全屏编辑+预览
                    splitter1.position("0%");
                    splitter2.position("60%");
                    event.preventDefault();
                }
            });

        });
    </script>
{% endblock %}